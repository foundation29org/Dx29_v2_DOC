

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.3. Automation &mdash; Dx29 v2 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4.4. Running and working locally" href="4_Locally.html" />
    <link rel="prev" title="4.2. Deploy" href="2_Deploy.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Dx29 v2
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Dx29 v2</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture.html">1. Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/SystemContext.html">1.1. Level 1: System Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/Containers.html">1.2. Level 2: Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/Components.html">1.3. Level 3: Component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/Code.html">1.4. Level 4: Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_DataModels.html">2. Data models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_Environments.html">3. Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_Environments/1_AKS-DEV.html">3.1. Dev Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_Environments/2_AKS-TEST.html">3.2. Test environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_Environments/3_AKS-PRO.html">3.3. Prod environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_Environments/4_ScriptsCreateAndDeploy.html">3.4. Scripts for create and deploy environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_BuildAndDeploy.html">4. Build &amp; Deploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="1_Build.html">4.1. Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_Deploy.html">4.2. Deploy</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">4.3. Automation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#create-new-aks-pipeline">4.3.1.  Create new AKS pipeline.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pipeline-yamls">4.3.2.  Pipeline YAMLs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#a-yaml-file-of-the-pipeline">a. YAML FILE OF THE PIPELINE</a></li>
<li class="toctree-l3"><a class="reference internal" href="#b-deployment-yaml">b. DEPLOYMENT YAML</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-service-yaml">c. SERVICE YAML</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#important-notes">4.3.3.  Important notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#check-status-of-deployment">4.3.4.  Check status of deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dx29-pipelines-by-environment">4.3.5.  Dx29 pipelines by environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#development-dx29-pipelines">4.3.5.1.  Development Dx29 pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-dx29-pipelines">4.3.5.2.  Test Dx29 pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="#production-dx29-pipelines">4.3.5.3.  Production Dx29 pipelines</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="4_Locally.html">4.4. Running and working locally</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_CurrentStatus.html">4.5. Current Status of the environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5_CodeGuidelines.html">5. Code Guidelines</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Dx29 v2</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>4.3. Automation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/pages/4_BuildAndDeploy/3_Automation.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <img align="right" width="100px" src="../../_images/Foundation29.png"><div class="section" id="automation">
<h1>4.3. Automation<a class="headerlink" href="#automation" title="Permalink to this headline">¶</a></h1>
<p>To perform the tasks of building and deploying microservices in different environments, we have created a list of Azure Pipelines that will allow us to automate these tasks and perform them in a more secure way.</p>
<img width="800px" src="../../_images/aks_pipelines.png"><p>Thus, these pipelines will be organised in this way for each environment:</p>
<blockquote>
<div><ul class="simple">
<li>Development environment. Each project (microservice) will have its own pipeline that will: access the code repository, use the code from the develop branch, use the manifest files defined in this directory and perform the build and deploy tasks on the Container Registry and the AKS of the development environment.</li>
<li>Test environment. It consists of a single pipeline located in the private repository Dx29.EnvTest. This will define all the stages to be performed on the microservices to be published in test: those of build and those of deploy. To do so, it will access the code of the repository containing the project associated with the microservice you want to work with, it will use the code available in its main branch, and then it will use the manifests files found in the Dx29.EnvTEST repository to perform the build and deploy tasks on the Container Registry and the test AKS.</li>
<li>Production environment. This environment shares Container Registry with test, so that it will only access it to obtain the images already generated and compiled to be used in the production environment, that is to say, it will not perform build tasks, only deploy. It consists of only one pipeline located in the private repository Dx29.EnvPRO. This will define the deployment stages to be performed on the microservices to be published in production. To do this, it will access the Test Container Registry, take the corresponding image and deploy it to the production AKS.</li>
</ul>
</div></blockquote>
<div class="section" id="create-new-aks-pipeline">
<h2>4.3.1.  Create new AKS pipeline.<a class="headerlink" href="#create-new-aks-pipeline" title="Permalink to this headline">¶</a></h2>
<p>For the deployment of the different components, we will use the Azure Devops Pipeline template to create a pipeline for an <a class="reference external" href="https://docs.microsoft.com/en-GB/azure/aks/intro-kubernetes">AKS</a>.</p>
<p>So, once the project repository has been created and the functionality has been programmed or implemented, the steps to follow are as follows:</p>
<blockquote>
<div><ul class="simple">
<li><ol class="first">
<li>Access Azure Devops Pipelines and create a “New pipeline”.</li>
</ol>
</li>
</ul>
</div></blockquote>
<p style="text-align: center;">
  <img width="800px" src="../../_images/pipelines_1.PNG">
<p><blockquote>
<div><ul class="simple">
<li><ol class="first">
<li>Select Azure Repos Git as the input source.</li>
</ol>
</li>
</ul>
</div></blockquote>
<p style="text-align: center;">
  <img width="500px" src="../../_images/pipelines_2.PNG">
<p><blockquote>
<div><ul class="simple">
<li><ol class="first">
<li>Select the code repository of the component.</li>
</ol>
</li>
</ul>
</div></blockquote>
<p style="text-align: center;">
  <img width="500px" src="../../_images/pipelines_3.PNG">
<p><blockquote>
<div><ul class="simple">
<li><ol class="first">
<li>Among the available options, choose: “Deploy to Azure Kubernetes Service”.</li>
</ol>
</li>
</ul>
</div></blockquote>
<p style="text-align: center;">
  <img width="500px" src="../../_images/pipelines_4.PNG">
<p><blockquote>
<div><ul class="simple">
<li><ol class="first">
<li>Configure the pipeline resources according to the Azure cluster to be used:</li>
</ol>
</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>a.  Select Azure Subscription</li>
<li>b.  Select the cluster.</li>
<li>c.  Check namespace as “Existing” and select the one that you want to use for deployment. Normally this field is: “app-ingress”.</li>
<li>d.  Finally, enter the name of the image you want the pipeline to create for use in the cluster and check the port configuration. Normally this should be:</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>The image should follow the pattern: <code class="docutils literal notranslate"><span class="pre">dx29-&lt;image</span> <span class="pre">name&gt;</span></code>.</li>
<li>The port is 80 for microservices implemented in C# and 8080 for Nodejs ones.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<p style="text-align: center;">
  <img width="500px" src="../../_images/pipelines_5.PNG">
<p><p>After clicking on Validate and configure, the YAML with the content of our pipeline will be automatically generated. At this point we must make the necessary modifications to ensure that: The image name complies with the pattern <code class="docutils literal notranslate"><span class="pre">dx29-&lt;image</span> <span class="pre">name&gt;</span></code> and that the environment used corresponds to where we want to display the image (Dx29-DEV.app-ingress, Dx29-TEST.app-ingress or Dx29-PROD.app-ingress).
When we are sure of this we can save and finish. This will cause the following files to be added to the repository:</p>
<blockquote>
<div><ul class="simple">
<li>The Manifests directory with two YAMLs: the deployment and the service.</li>
<li>The Azure pipeline YAML file.</li>
</ul>
</div></blockquote>
<p>The following section explains the content of these files.</p>
</div>
<div class="section" id="pipeline-yamls">
<h2>4.3.2.  Pipeline YAMLs<a class="headerlink" href="#pipeline-yamls" title="Permalink to this headline">¶</a></h2>
<p>For each pipeline you have:</p>
<ol class="simple">
<li>A Manifests folder with two YAML files: Deployment and Service, with the configuration for the deploy in Kubernetes.</li>
<li>The YAML file of the Pipeline with the steps and tasks to be performed by it.</li>
</ol>
<p>In this section the content of each of these files will be explained.</p>
<div class="section" id="a-yaml-file-of-the-pipeline">
<h3>a. YAML FILE OF THE PIPELINE<a class="headerlink" href="#a-yaml-file-of-the-pipeline" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th>Section</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>trigger</td>
<td>- develop/main</td>
<td>For the automatic execution of the pipeline, you can set a trigger of one of the branches of the project, so that if any modification is made on it, the pipeline will be launched.</td>
</tr>
<tr>
<td>resources</td>
<td>- repo: self</td>
<td>The repository where the project code is located. Normally this value is "self" and refers to the repository on which the Pipeline was created, but it is possible to access any repository according to this <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/repos/multi-repo-checkout?view=azure-devops">link</a></td>
</tr>
<tr>
<td>variables</td>
<td>vmImageName: 'ubuntu-latest'</td>
<td>Definition of variables to be used in the different steps of the Pipeline.</td>
</tr>
<tr>
<td>stages</td>
<td>- stage: Build displayName: Build stage</td>
<td>Stages are the major divisions in a pipeline. They are logical boundaries in your pipeline where you can pause the pipeline and perform various checks. Every pipeline has at least one stage even if you do not explicitly define it. In our case the Deployment pipelines will be formed by two Stages: Build and Deploy. The corresponding jobs will be performed in each of them.</td>
</tr>
<tr>
<td>jobs</td>
<td>- job: Build</td>
<td>A stage contains one or more jobs. Each job runs on an agent. A job represents an execution boundary of a set of steps. All the steps run together on the same agent. In our case, for each stage, a Job will be created: Build or Deploy in each case. We configured the Deploy Job according to this <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/deployment-jobs?view=azure-devops">link</a></td>
</tr>
<tr>
<td>steps</td>
<td>- task</td>
<td>Steps are implemented by tasks. This is where the sequence of tasks to be executed is defined. Steps are run sequentially, one after another. Before a step can start, all the previous steps must be finished (or skipped). In our case, for the Build job two tasks will be added: Build and push the docker image of the microservice to the container registry; and Upload the manifests of the pipeline (artifacts) that will be used later by the Deploy job. For the Deploy job two tasks will be added: Create a secret image to have permissions to access the container registry; and Use the deployment and service YAMLs that will be explained later in this document to deploy the artifacts from the previous job to the AKS.</td>
</tr>
</tbody>
</table></div>
<div class="section" id="b-deployment-yaml">
<h3>b. DEPLOYMENT YAML<a class="headerlink" href="#b-deployment-yaml" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span> <span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">dx29</span><span class="o">-&lt;</span><span class="n">microservice_name</span><span class="o">&gt;-</span><span class="n">deployment</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">dx29</span><span class="o">-&lt;</span><span class="n">microservice_name</span><span class="o">&gt;-</span><span class="n">backend</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">dx29</span><span class="o">-&lt;</span><span class="n">microservice_name</span><span class="o">&gt;-</span><span class="n">backend</span> 
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">dx29</span><span class="o">-&lt;</span><span class="n">microservice_name</span><span class="o">&gt;-</span><span class="n">backend</span> 
          <span class="n">image</span><span class="p">:</span> <span class="n">dx29devs</span><span class="o">.</span><span class="n">azurecr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">dx29</span><span class="o">-&lt;</span><span class="n">microservice_name</span><span class="o">&gt;-</span>
          <span class="n">ports</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8080</span>
</pre></div>
</div>
<p>In this example:</p>
<blockquote>
<div><ul class="simple">
<li>A Deployment named <code class="docutils literal notranslate"><span class="pre">dx29-&lt;microservice_name&gt;-deployment</span></code> is created, indicated by the .metadata.name field.</li>
<li>The Deployment creates ONLY ONE replicated Pod, indicated by the .spec.replicas field.</li>
<li>The .spec.selector field defines how the Deployment finds which Pods to manage. In this case, you select a label that is defined in the Pod template (app: <code class="docutils literal notranslate"><span class="pre">dx29-&lt;microservice_name&gt;-backend</span></code>). However, more sophisticated selection rules are possible, as long as the Pod template itself satisfies the rule.
Note: The .spec.selector.matchLabels field is a map of {key,value} pairs. A single {key,value} in the matchLabels map is equivalent to an element of matchExpressions, whose key field is “key” the operator is “In”, and the values array contains only “value”. All of the requirements, from both matchLabels and matchExpressions, must be satisfied in order to match.</li>
<li>The template field contains the following sub-fields:</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>The Pods are labeled app:<code class="docutils literal notranslate"><span class="pre">dx29-&lt;microservice_name&gt;-backend</span></code> the .metadata.labels field.</li>
<li>The Pod template’s specification, or .template.spec field, indicates that the Pods run one container, <code class="docutils literal notranslate"><span class="pre">dx29-&lt;microservice_name&gt;-backend</span></code>, which runs the <code class="docutils literal notranslate"><span class="pre">dx29-&lt;microservice_name&gt;-backend</span></code> Docker Hub image.</li>
<li>Create one container and name it <code class="docutils literal notranslate"><span class="pre">dx29-&lt;microservice_name&gt;-backend</span></code> using the .spec.template.spec.containers[0].name field.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="c-service-yaml">
<h3>c. SERVICE YAML<a class="headerlink" href="#c-service-yaml" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">dx29</span><span class="o">-&lt;</span><span class="n">microservice_name</span><span class="o">&gt;</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">app</span><span class="o">-</span><span class="n">ingress</span>
<span class="n">spec</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">ClusterIP</span>
    <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">port</span><span class="p">:</span> <span class="mi">8080</span> 
    <span class="n">selector</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">dx29</span><span class="o">-&lt;</span><span class="n">microservice_name</span><span class="o">&gt;-</span><span class="n">backend</span>
</pre></div>
</div>
<p>The key to sending requests from a frontend to a backend is the backend Service. A Service creates a persistent IP address and DNS name entry so that the backend microservice can always be reached. A Service uses selectors to find the Pods that it routes traffic to.</p>
<p>In this example you can see that the Service, named <code class="docutils literal notranslate"><span class="pre">dx29-&lt;microservice_name&gt;</span></code> routes traffic to Pods that have the label app <code class="docutils literal notranslate"><span class="pre">dx29-&lt;microservice_name&gt;-backend</span></code>.
Different types of services can be configured, in the dx29 v2 application the ones we will find are:</p>
<blockquote>
<div><ul class="simple">
<li>LoadBalancer only for the services that are exposed outwards: dx29-web and dx29-api-gateway.</li>
<li>ClusterIP for the rest of the microservices.</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="important-notes">
<h2>4.3.3.  Important notes<a class="headerlink" href="#important-notes" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><strong>If we are in the repository that contains the manifest files but we need to access another repository to obtain the project code</strong>:</li>
</ul>
<blockquote>
<div>We must configure the repository as a resource of the pipeline, before any stage has been declared:</div></blockquote>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resources</span><span class="p">:</span>  
  <span class="n">repositories</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">repository</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">repository_name</span><span class="o">&gt;</span>
    <span class="n">name</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">repository_name</span><span class="o">&gt;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">git</span>
    <span class="n">ref</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">branch</span><span class="o">&gt;</span> 
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>Add <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">checkout:</span> <span class="pre">&lt;repository_name&gt;</span></code> before execute the task (steps).</div></blockquote>
</div></blockquote>
<blockquote>
<div><ul class="simple">
<li><strong>If we want to deploy several microservices (as in the case of test and prod) we can organise the stages in different files or templates accessed by the main pipeline</strong>:</li>
</ul>
<blockquote>
<div>Configure the pipelines stages as:</div></blockquote>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>stages:
  - template: &lt;template_path_and_name&gt;.yml
    parameters:
      &lt;input_parameters_template&gt; (i.e. vmImageName: $(vmImageName))
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>In template.yaml only configure the stages:</div></blockquote>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stages</span><span class="p">:</span>
<span class="o">-</span> <span class="n">stage</span><span class="p">:</span> <span class="n">Build</span>
	<span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>And use the inout parameters as: <code class="docutils literal notranslate"><span class="pre">${{parameters.vmImageName}}</span></code></div></blockquote>
</div></blockquote>
<blockquote>
<div><ul class="simple">
<li><strong>If we want to work with the input parameters in a pipeline execution, we have to add</strong>:
We can use the runtime parameters as the <a class="reference external" href="https://docs.microsoft.com/en-GB/azure/devops/pipelines/process/runtime-parameters?view=azure-devops&amp;tabs=script">guide</a> describe:</li>
</ul>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parameters</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">tag</span>
  <span class="n">displayName</span><span class="p">:</span> <span class="n">Tag</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">string</span>
  <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;v0.00.00&#39;</span>
</pre></div>
</div>
<blockquote>
<div><ul class="simple">
<li><strong>If we want to work with pipeline variables that will share several templates, i.e. organise the variables in a single file</strong>:</li>
</ul>
<blockquote>
<div>As with the pipeline stage definition templates, variables can also be configured within another file.
This file will be in the format:</div></blockquote>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">variables</span><span class="p">:</span>

  <span class="c1"># Container registry service connection established during pipeline creation</span>
  <span class="n">dockerRegistryServiceConnection</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">secret</span><span class="o">&gt;</span>
  <span class="n">containerRegistry</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">acr_server</span><span class="o">&gt;</span>
  <span class="n">dockerfilePath</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">path_Dockerfile</span><span class="o">&gt;</span>
  <span class="n">imagePullSecret</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">image_pull_secret_AKS</span><span class="o">&gt;</span>

  <span class="c1"># Agent VM image name</span>
  <span class="n">vmImageName</span><span class="p">:</span> <span class="s1">&#39;ubuntu-latest&#39;</span>

  <span class="n">environment</span><span class="p">:</span>  <span class="o">&lt;</span><span class="n">environment_name</span><span class="o">.</span><span class="n">namespace</span><span class="o">&gt;</span>

  <span class="c1"># Images</span>
  <span class="n">imageRepositoryX</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">imageX_name</span><span class="o">&gt;</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>And it will be imported into the main pipeline as:</div></blockquote>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">variables</span><span class="p">:</span>
<span class="o">-</span> <span class="n">template</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">path_and_varsFileName</span><span class="o">&gt;.</span><span class="n">yaml</span>
</pre></div>
</div>
</div>
<div class="section" id="check-status-of-deployment">
<h2>4.3.4.  Check status of deployment<a class="headerlink" href="#check-status-of-deployment" title="Permalink to this headline">¶</a></h2>
<p>To check if the deploy of a component has been carried out correctly:</p>
<blockquote>
<div><ul class="simple">
<li><ol class="first">
<li>Check that the Pipeline has been executed correctly.</li>
</ol>
</li>
<li><ol class="first">
<li>Check in the corresponding Container Registry that the image has been created.</li>
</ol>
</li>
<li><ol class="first">
<li>Check in the corresponding AKS that:</li>
</ol>
</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>a.  The Deployment (Azure AKS - workloads) is “Ready” .</li>
<li>b.  The service status is OK, it is of the correct type and has an associated IP.</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="dx29-pipelines-by-environment">
<h2>4.3.5.  Dx29 pipelines by environment<a class="headerlink" href="#dx29-pipelines-by-environment" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="development-dx29-pipelines">
<h2>4.3.5.1.  Development Dx29 pipelines<a class="headerlink" href="#development-dx29-pipelines" title="Permalink to this headline">¶</a></h2>
<p>To deploy the development environment there will be a Pipeline for each component (web and microservices) that will be executed automatically when changes are made to the develop branch of each project.
In this way, the dev environment is formed/updated on the fly with new implementations.
It does not have version control.</p>
</div>
<div class="section" id="test-dx29-pipelines">
<h2>4.3.5.2.  Test Dx29 pipelines<a class="headerlink" href="#test-dx29-pipelines" title="Permalink to this headline">¶</a></h2>
<p>In this case, a repository has been created in Azure Repos: Dx29.Test (and an open source version has been uploaded as an example to github: <a class="reference external" href="https://github.com/foundation29org/Dx29.Pipelines_all">Dx29.Pipelines_all</a>) where the YAML of the test pipeline and the manifest files needed to deploy the environment will be located.</p>
<p>There will be a single YAML that has access to the different repositories of the Dx29 component projects (web and microservices) and uses templates to build the images of each of them and deploy them in the test environment.
In this way, there will be a main pipeline that will use as templates those of the different components of the application according to <a class="reference external" href="ttps://stackoverflow.com/questions/64777703/azure-pipelines-using-yaml-for-multiple-environments-stages-with-different-var">this</a>.</p>
<p style="text-align: center;">
  <img width="600px" src="../../_images/pipelines_test_1.PNG">
<p><blockquote>
<div><ul class="simple">
<li>Azure-pipelines.yaml is the main file.</li>
<li>Folder templates contains the YAML files for each component.</li>
</ul>
</div></blockquote>
<p style="text-align: center;">
  <img width="600px" src="../../_images/pipelines_test_2.PNG">
<p><blockquote>
<div><ul class="simple">
<li>Folder manifests contains the manifests for each component (deployment and service).</li>
</ul>
</div></blockquote>
<p style="text-align: center;">
  <img width="600px" src="../../_images/pipelines_test_3.PNG">
<p><p>For each component, the repository where the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/repos/multi-repo-checkout?view=azure-devops">source code is located will be accessed</a>.
Each of the files that appear in Templates and manifest are copies of the development environment files for each component, although the content will be slightly modified for the test environment.
With all this:</p>
<blockquote>
<div><ul class="simple">
<li>The structure of the pipelines for each template will be as indicated in this document (in the previous sections) having only the Build and Deploy stages for each component. That is to say: trigger, repositories and variables are eliminated.</li>
<li>The names of the stages of each component must be modified (they cannot all be called the same) and indicate for which component this stage is being carried out and if it is related to any of them.</li>
<li>The environment on which the deployment is performed is modified: <code class="docutils literal notranslate"><span class="pre">&lt;name_environment_test&gt;.&lt;aks_namespace&gt;</span></code>.</li>
<li>All the variables become parameters, so that when you want to use the template, from the main pipeline you must indicate with which values you want to perform the operations. The access will now be done as a parameter, not as a variable.</li>
<li>These pipelines will use the manifest corresponding to each component so that, inside the manifest folder, the deployment and service files are renamed indicating the component to which they belong and updated in the corresponding template pipeline.</li>
<li>A checkout step is added. This task will oversee choosing the repository on which the operations will be carried out, thus: the build tasks will be executed using the component repository while the build tasks will be executed from the Test repository.</li>
<li>Within each deployment file, the image container must be modified so that the test container is used: <code class="docutils literal notranslate"><span class="pre">&lt;acr_test_server&gt;/&lt;image_name&gt;</span></code>.</li>
</ul>
</div></blockquote>
<p>The main pipeline:</p>
<blockquote>
<div><ul class="simple">
<li>It will configure the access to the different code repositories.</li>
<li>It will define the variables to work with.</li>
<li>And it will include as a stage each of the templates implemented for each component of the application, passing the values of the previous variables as parameters.</li>
</ul>
</div></blockquote>
<p>Finally, this pipeline will also have an input parameter that can be used for version control. This is explained in the next section of this document.
When this pipeline is launched, a Tag or version will be indicated so that:</p>
<ol class="simple">
<li>All images of the application components with that tag will be compiled and uploaded to the container registry.</li>
<li>Deploy the images with the tag indicated in the cluster (AKS).</li>
</ol>
<p>Therefore, the execution of this pipeline is manual.</p>
<p>For version control an input parameter to the pipeline will be used: Tag.
When running the test pipeline, you must specify which version you want to deploy, so that all images with that version will be generated and uploaded.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parameters</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">tag</span>
  <span class="n">displayName</span><span class="p">:</span> <span class="n">Tag</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">string</span>
  <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;v0.0.1&#39;</span>
</pre></div>
</div>
<p>When launching the pipeline, you can choose which losstages you want to run.
Be careful with this option because when uploading to production you have to choose the version you want to upload, and therefore the images must exist.</p>
</div>
<div class="section" id="production-dx29-pipelines">
<h2>4.3.5.3.  Production Dx29 pipelines<a class="headerlink" href="#production-dx29-pipelines" title="Permalink to this headline">¶</a></h2>
<p>It will be the same as the test pipeline but only with the deploy stages. In this case only the selected images will be accessed with the input parameter tag/version and deployed to the production cluster.
The pipelines can be found in the repository Dx29.Prod, and an open source version has been uploaded as an example to github: <a class="reference external" href="https://github.com/foundation29org/Dx29.Pipelines_only_deploy">Dx29.Pipelines_only_deploy</a></p>
<p>This pipeline will also not be executed automatically but must be launched manually.</p>
<p>For version control there is a variables yaml file with the tags of all images that the pipeline deploy on Dx29 production environment.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="4_Locally.html" class="btn btn-neutral float-right" title="4.4. Running and working locally" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="2_Deploy.html" class="btn btn-neutral float-left" title="4.2. Deploy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Foundation29

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>