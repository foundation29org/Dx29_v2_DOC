

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2.4. Scripts for create and deploy environments &mdash; Dx29 v2 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6. Build &amp; Deploy" href="../3_BuildAndDeploy.html" />
    <link rel="prev" title="2.3. Prod environment" href="3_AKS-PRO.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Dx29 v2
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Dx29 v2</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture.html">1. Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/SystemContext.html">1.1. Level 1: System Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/Containers.html">1.2. Level 2: Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/Components.html">1.3. Level 3: Component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/Code.html">1.4. Level 4: Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_Environments.html">2. Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="1_AKS-DEV.html">2.1. Dev Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_AKS-TEST.html">2.2. Test environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_AKS-PRO.html">2.3. Prod environment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2.4. Scripts for create and deploy environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_BuildAndDeploy.html">6. Build &amp; Deploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_BuildAndDeploy/1_Build.html">6.1. Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_BuildAndDeploy/2_Deploy.html">6.2. Deploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_BuildAndDeploy/3_Automation.html">6.3. Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_BuildAndDeploy/4_Locally.html">6.4. Running and working locally</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_BuildAndDeploy/5_CurrentStatus.html">6.5. Current Status of the environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_CodeGuidelines.html">7. Code Guidelines</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Dx29 v2</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>2.4. Scripts for create and deploy environments</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/pages/2_Environments/4_ScriptsCreateAndDeploy.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <img align="right" width="100px" src="../../_images/Foundation29.png"><div class="section" id="scripts-for-create-and-deploy-environments">
<h1>2.4. Scripts for create and deploy environments<a class="headerlink" href="#scripts-for-create-and-deploy-environments" title="Permalink to this headline">Â¶</a></h1>
<p>To create and configure the different environments, a list of scripts has been implemented in the Dx29.Environments project.
In it you can find the different steps necessary to deploy from scratch each of the environments, and also how to add the file with the values or secret keys required by the different components of the application in a secure way.</p>
<p>In general, these scripts contain the kubectl commands necessary for the deployment of the environment and the association of the components included in it. So, for each of the environments, these are the steps that will be followed:</p>
<ol class="simple">
<li>Create new <a class="reference external" href="https://docs.microsoft.com/en-GB/azure/azure-resource-manager/management/manage-resource-groups-portal">resource group</a> for the environment</li>
<li>Create an AKS using <a class="reference external" href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough">Azure CLI</a></li>
<li>Create new Azure container registry using <a class="reference external" href="https://docs.microsoft.com/en-GB/azure/container-registry/container-registry-get-started-azure-cli">Azure CLI</a></li>
<li>Using Script for configure the environment:</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get credentials </span>
<span class="n">az</span> <span class="n">aks</span> <span class="n">get</span><span class="o">-</span><span class="n">credentials</span> <span class="o">--</span><span class="n">resource</span><span class="o">-</span><span class="n">group</span> <span class="o">&lt;</span><span class="n">resource_group_name</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">name</span> <span class="o">&lt;</span><span class="n">azure_aks_name</span><span class="o">&gt;</span>

<span class="c1"># Only first time: Attach Azure Container Registry</span>
<span class="c1">#az aks update --resource-group &lt;resource_group_name&gt; --name &lt;azure_aks_name&gt; --attach-acr &lt;azure_acr_name&gt;</span>

<span class="c1"># Create a namespace for your ingress resources</span>
<span class="c1">#kubectl create namespace app-ingress</span>

<span class="c1"># Add the official stable repository</span>
<span class="n">helm</span> <span class="n">repo</span> <span class="n">add</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span>

<span class="c1"># Use Helm to deploy an NGINX ingress controller</span>
<span class="n">helm</span> <span class="n">install</span> <span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span><span class="o">/</span><span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">app</span><span class="o">-</span><span class="n">ingress</span> <span class="o">--</span><span class="nb">set</span> <span class="n">controller</span><span class="o">.</span><span class="n">replicaCount</span><span class="o">=</span><span class="mi">2</span>

<span class="c1"># Install the CustomResourceDefinition resources separately</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">--</span><span class="n">validate</span><span class="o">=</span><span class="n">false</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">jetstack</span><span class="o">/</span><span class="n">cert</span><span class="o">-</span><span class="n">manager</span><span class="o">/</span><span class="n">release</span><span class="o">-</span><span class="mf">0.11</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">manifests</span><span class="o">/</span><span class="mi">00</span><span class="o">-</span><span class="n">crds</span><span class="o">.</span><span class="n">yaml</span>

<span class="c1"># Create the namespace for cert-manager</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="n">namespace</span> <span class="n">cert</span><span class="o">-</span><span class="n">manager</span>

<span class="c1"># Label the cert-manager namespace to disable resource validation</span>
<span class="n">kubectl</span> <span class="n">label</span> <span class="n">namespace</span> <span class="n">cert</span><span class="o">-</span><span class="n">manager</span> <span class="n">cert</span><span class="o">-</span><span class="n">manager</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">disable</span><span class="o">-</span><span class="n">validation</span><span class="o">=</span><span class="n">true</span>

<span class="c1"># Add the Jetstack Helm repository</span>
<span class="n">helm</span> <span class="n">repo</span> <span class="n">add</span> <span class="n">jetstack</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">charts</span><span class="o">.</span><span class="n">jetstack</span><span class="o">.</span><span class="n">io</span>

<span class="c1"># Update your local Helm chart repository cache</span>
<span class="n">helm</span> <span class="n">repo</span> <span class="n">update</span>

<span class="c1"># Install the cert-manager Helm chart</span>
<span class="n">helm</span> <span class="n">install</span> <span class="n">cert</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">cert</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="n">version</span> <span class="n">v0</span><span class="o">.</span><span class="mf">11.0</span> <span class="n">jetstack</span><span class="o">/</span><span class="n">cert</span><span class="o">-</span><span class="n">manager</span>

<span class="c1"># Apply cluster-issuer staging</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">cluster</span><span class="o">-</span><span class="n">issuer</span><span class="o">.</span><span class="n">yaml</span>

<span class="c1"># Apply app-ingress staging</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">app</span><span class="o">-</span><span class="n">ingress</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">app</span><span class="o">-</span><span class="n">ingress</span>

<span class="c1"># Check status</span>
<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">certificate</span> <span class="n">tls</span><span class="o">-</span><span class="n">secret</span><span class="o">-</span><span class="n">pro</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">app</span><span class="o">-</span><span class="n">ingress</span>
</pre></div>
</div>
<p>It is important to point out that for the execution of this script it will be necessary to use the configuration files of:</p>
<blockquote>
<div><ul class="simple">
<li><strong>app-ingress.yaml</strong></li>
</ul>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Ingress</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">app</span><span class="o">-</span><span class="n">ingress</span>
  <span class="n">annotations</span><span class="p">:</span>
    <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">ingress</span><span class="o">.</span><span class="n">class</span><span class="p">:</span> <span class="n">nginx</span>
    <span class="n">cert</span><span class="o">-</span><span class="n">manager</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">cluster</span><span class="o">-</span><span class="n">issuer</span><span class="p">:</span> <span class="n">letsencrypt</span><span class="o">-</span><span class="n">pro</span>
    <span class="n">nginx</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">ssl</span><span class="o">-</span><span class="n">redirect</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>
    <span class="n">nginx</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">enable</span><span class="o">-</span><span class="n">cors</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
    <span class="n">nginx</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">cors</span><span class="o">-</span><span class="n">allow</span><span class="o">-</span><span class="n">methods</span><span class="p">:</span> <span class="s2">&quot;GET, POST, PUT, PATCH, DELETE, OPTIONS&quot;</span>
    <span class="n">nginx</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">cors</span><span class="o">-</span><span class="n">allow</span><span class="o">-</span><span class="n">origin</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
    <span class="n">nginx</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">cors</span><span class="o">-</span><span class="n">allow</span><span class="o">-</span><span class="n">credentials</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
    <span class="n">nginx</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">cors</span><span class="o">-</span><span class="n">allow</span><span class="o">-</span><span class="n">headers</span><span class="p">:</span> <span class="s2">&quot;authorization, content-type, Ocp-Apim-Subscription-Key&quot;</span>
    <span class="n">nginx</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">proxy</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span>
    <span class="n">nginx</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">proxy</span><span class="o">-</span><span class="n">connect</span><span class="o">-</span><span class="n">timeout</span><span class="p">:</span> <span class="s2">&quot;3600&quot;</span>
    <span class="n">nginx</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">proxy</span><span class="o">-</span><span class="n">read</span><span class="o">-</span><span class="n">timeout</span><span class="p">:</span> <span class="s2">&quot;3600&quot;</span>
    <span class="n">nginx</span><span class="o">.</span><span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">proxy</span><span class="o">-</span><span class="n">send</span><span class="o">-</span><span class="n">timeout</span><span class="p">:</span> <span class="s2">&quot;3600&quot;</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">tls</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">hosts</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">&lt;</span><span class="n">Environment_URL_Address</span><span class="o">&gt;</span>
    <span class="n">secretName</span><span class="p">:</span> <span class="n">tls</span><span class="o">-</span><span class="n">secret</span><span class="o">-</span><span class="n">pro</span>
  <span class="n">rules</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">host</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Environment_URL_Address</span><span class="o">&gt;</span>
    <span class="n">http</span><span class="p">:</span>
      <span class="n">paths</span><span class="p">:</span> 
      <span class="o">-</span> <span class="n">path</span><span class="p">:</span> <span class="o">/</span>
        <span class="n">backend</span><span class="p">:</span>
          <span class="n">serviceName</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">service_that_contains_frontend_app</span><span class="o">&gt;</span>
          <span class="n">servicePort</span><span class="p">:</span> <span class="mi">80</span>
</pre></div>
</div>
<blockquote>
<div><ul class="simple">
<li><strong>cluster-issuer.yaml</strong></li>
</ul>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">cert</span><span class="o">-</span><span class="n">manager</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha2</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterIssuer</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">letsencrypt</span><span class="o">-</span><span class="n">pro</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">app</span><span class="o">-</span><span class="n">ingress</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">acme</span><span class="p">:</span>
    <span class="n">server</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">acme</span><span class="o">-</span><span class="n">v02</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">letsencrypt</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">directory</span>
    <span class="n">email</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">user_letsencrypt_email</span><span class="o">&gt;</span>
    <span class="n">privateKeySecretRef</span><span class="p">:</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">letsencrypt</span><span class="o">-</span><span class="n">pro</span>
    <span class="n">solvers</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">http01</span><span class="p">:</span>
        <span class="n">ingress</span><span class="p">:</span>
          <span class="n">class</span><span class="p">:</span> <span class="n">nginx</span>
</pre></div>
</div>
<p>Finally, for the creation and update of the <strong>secrets files</strong> in an environment, these are the steps to follow:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get credentials</span>
<span class="n">az</span> <span class="n">aks</span> <span class="n">get</span><span class="o">-</span><span class="n">credentials</span> <span class="o">--</span><span class="n">resource</span><span class="o">-</span><span class="n">group</span> <span class="o">&lt;</span><span class="n">resource_group_name</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">name</span> <span class="o">&lt;</span><span class="n">azure_aks_name</span><span class="o">&gt;</span>

<span class="c1"># Access to folder where you have save the file to upload in local.</span>

<span class="c1"># Create secret</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="n">secret</span> <span class="n">generic</span> <span class="n">secret</span><span class="o">-</span><span class="n">appsettings</span> <span class="o">--</span><span class="n">from</span><span class="o">-</span><span class="n">file</span><span class="o">=./</span><span class="n">appsettings</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">json</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">app</span><span class="o">-</span><span class="n">ingress</span>

<span class="c1"># Update secret</span>
<span class="n">kubectl</span> <span class="n">delete</span> <span class="n">secret</span> <span class="n">secret</span><span class="o">-</span><span class="n">appsettings</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">app</span><span class="o">-</span><span class="n">ingress</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="n">secret</span> <span class="n">generic</span> <span class="n">secret</span><span class="o">-</span><span class="n">appsettings</span> <span class="o">--</span><span class="n">from</span><span class="o">-</span><span class="n">file</span><span class="o">=./</span><span class="n">appsettings</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">json</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">app</span><span class="o">-</span><span class="n">ingress</span>
<span class="c1"># And then deploy the components/microservices that consumes it.</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../3_BuildAndDeploy.html" class="btn btn-neutral float-right" title="6. Build &amp; Deploy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="3_AKS-PRO.html" class="btn btn-neutral float-left" title="2.3. Prod environment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Foundation29

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>