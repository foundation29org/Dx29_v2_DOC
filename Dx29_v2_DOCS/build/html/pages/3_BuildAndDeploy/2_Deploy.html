

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.2. Deploy &mdash; Dx29 v2 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3.3. Automation" href="3_Automation.html" />
    <link rel="prev" title="3.1. Build" href="1_Build.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Dx29 v2
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Dx29 v2</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture.html">1. Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/SystemContext.html">1.1. Level 1: System Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/Containers.html">1.2. Level 2: Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/Components.html">1.3. Level 3: Component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_Architecture/Code.html">1.4. Level 4: Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_Environments.html">2. Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_Environments/1_AKS-DEV.html">2.1. Dev Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_Environments/2_AKS-TEST.html">2.2. Test environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_Environments/3_AKS-PRO.html">2.3. Prod environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_Environments/4_ScriptsCreateAndDeploy.html">2.4. Scripts for create and deploy environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_BuildAndDeploy.html">3. Build &amp; Deploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="1_Build.html">3.1. Build</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3.2. Deploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_Automation.html">3.3. Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_Locally.html">3.4. Running and working locally</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_CurrentStatus.html">3.5. Current Status of the environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_CodeGuidelines.html">4. Code Guidelines</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Dx29 v2</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>3.2. Deploy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/pages/3_BuildAndDeploy/2_Deploy.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <img align="right" width="100px" src="../../_images/Foundation29.png"><div class="section" id="deploy">
<h1>3.2. Deploy<a class="headerlink" href="#deploy" title="Permalink to this headline">¶</a></h1>
<p>The concept of microservices that allows several small applications to communicate with each other to provide a specific functionality.
If the number of applications grows in our system, it becomes complicated to manage. Docker is not enough, as we need coordination for deployment, service monitoring, replacement, automatic scaling and, ultimately, management of the various services that make up our distributed architecture. This is where Kubernetes comes in.</p>
<p>Kubernetes is an open source platform for automating the deployment, scaling and management of containerised applications.</p>
<blockquote>
<div><ul class="simple">
<li>Ready to scale. You can scale without growing your operations team.</li>
<li>Ready for any complexity. The flexibility of Kubernetes grows with you to deliver your applications consistently and easily regardless of complexity.</li>
<li>Ready to run anywhere. It’s open source which gives you the freedom to leverage your on-premises, hybrid or public cloud infrastructure, allowing you to effortlessly move workloads wherever you want.</li>
</ul>
</div></blockquote>
<p>First, we need to store our Docker images somewhere besides on our laptops. The Kubernetes cluster needs a fast and reliable Docker repository from which to pull the images. For this, we use <a class="reference external" href="https://docs.microsoft.com/en-GB/azure/container-registry/">Azure Container Registry</a>.</p>
<img width="800px" src="../../_images/docker_acr.png"><p>Steps to upload images to the Azure Container Registry using <a class="reference external" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Azure-CLI</a>:</p>
<ol class="simple">
<li>Log in to Azure: <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">login</span></code>.</li>
<li>If there is more than one subscription, select the one where the service has been created through this other command: <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">account</span> <span class="pre">set</span> <span class="pre">-s</span> <span class="pre">SUBSCRIPTION_ID</span></code>.</li>
<li>Login to the Azure Container Registry, entering your name: <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">acr</span> <span class="pre">login</span> <span class="pre">--name</span> <span class="pre">&lt;name_acr&gt;</span></code>.</li>
<li>If the login was successful, the Login Succeeded message will appear. Before uploading the image to any registry it is necessary to use a specific nomenclature. In the case of Docker Hub it would be: your_username/repository:tag. For Azure Container Registry it is registry_server_name/repository:tag. Therefore, you have to run the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">tag</span></code> command to rename the image according to this nomenclature.
The server name can be found in Azure, in the Container Registry Overview as “login server”.</li>
<li>Publish the image to the Azure Container Registry, via <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">push</span> <span class="pre">&lt;image_name&gt;</span></code>. When the upload is complete, you will see the image in the Repositories section of the Azure Container Registry.</li>
</ol>
<p>Now that you have built and pushed your Docker images, you can deploy them to your Kubernetes cluster. The quickest way to get started is by using kubectl.</p>
<img width="800px" src="../../_images/steps_ACR_AKS.png"><p>For this we will need this Docker image located in the Container Registry (to which the Kubernetes cluster will have access) and the manifests files that will allow us to configure the deployments and services associated with each microservice.</p>
<p>The latter files will be YAML files containing the following information:</p>
<blockquote>
<div><ul class="simple">
<li><strong>Deployment.yaml</strong>: Describing a scalable group of identical pods. In the following example, you’ll get just one replica, or copy of your pod, and that pod (which is described under the template: key) has just one container in it, based off of your bulletinboard:1.0 image.</li>
</ul>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">bb</span><span class="o">-</span><span class="n">demo</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">bb</span><span class="p">:</span> <span class="n">web</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">bb</span><span class="p">:</span> <span class="n">web</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">bb</span><span class="o">-</span><span class="n">site</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">getting</span><span class="o">-</span><span class="n">started</span>
</pre></div>
</div>
<blockquote>
<div><ul class="simple">
<li><strong>Service.yaml</strong>: A NodePort service. In the following example it will route traffic from port 30001 on your host to port 3000 inside the pods it routes to, allowing you to reach your bulletin board from the network. For Dx29 application we are going to create services as ClusterIP.</li>
</ul>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">bb</span><span class="o">-</span><span class="n">entrypoint</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">bb</span><span class="p">:</span> <span class="n">web</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">port</span><span class="p">:</span> <span class="mi">3000</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="mi">3000</span>
    <span class="n">nodePort</span><span class="p">:</span> <span class="mi">30001</span>
</pre></div>
</div>
<p>Both files, always follows the same pattern:</p>
<blockquote>
<div><ul class="simple">
<li>The <em>apiVersion</em>, which indicates the Kubernetes API that parses this object</li>
<li>The <em>kind</em> indicating what sort of object this is</li>
<li>Some <em>metadata</em> applying things like names to your objects</li>
<li>The <em>spec</em> specifying all the parameters and configurations of your object.</li>
</ul>
</div></blockquote>
<p>As we already know some of the microservices we are going to run will need an associated volume that will contain the value of the keys or the <a class="reference external" href="https://kubernetes.io/docs/concepts/configuration/secret/">secret values</a> of the Dx29 application. To add this volume, the <strong>deployment.yaml</strong> file must be configured with a <strong>volume</strong> in its spec:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
	<span class="n">spec</span><span class="p">:</span>
		<span class="n">containers</span><span class="p">:</span>
			<span class="p">[</span><span class="o">...</span><span class="p">]</span>

			<span class="n">volumeMounts</span><span class="p">:</span>
          	<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">secrets</span>
              <span class="n">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">secrets</span>
              <span class="n">readOnly</span><span class="p">:</span> <span class="n">true</span>

		<span class="n">volumes</span><span class="p">:</span>
      	<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">secrets</span>
          <span class="n">secret</span><span class="p">:</span>
         	<span class="n">secretName</span><span class="p">:</span> <span class="n">secret</span><span class="o">-</span><span class="n">appsettings</span>
</pre></div>
</div>
<p>With this we can deploy the container with the microservice to the Kubernetes cluster following these steps:</p>
<ol class="simple">
<li>Log in to Azure: <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">login</span></code>.</li>
<li>Log in in AKS: <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">aks</span> <span class="pre">get-credentials</span> <span class="pre">--resource-group</span> <span class="pre">myResourceGroup</span> <span class="pre">--name</span> <span class="pre">myAKSCluster</span> </code></li>
<li>Apply deployment yaml. This makes it accessible from any node in your cluster: <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">apply</span> <span class="pre">-f</span> <span class="pre">deployment.yaml</span></code></li>
<li>Creating a service: A Kubernetes Service is an abstraction which defines a logical set of Pods running somewhere in your cluster, that all provide the same functionality. When created, each Service is assigned a unique IP address (also called clusterIP). This address is tied to the lifespan of the Service, and will not change while the Service is alive. Pods can be configured to talk to the Service, and know that communication to the Service will be automatically load-balanced out to some pod that is a member of the Service. <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">apply</span> <span class="pre">-f</span> <span class="pre">service.yaml</span> </code></li>
</ol>
<p>If we want to expose a microservice by a public IP (external), the following must be added to this configuration:</p>
<ul class="simple">
<li>Expose the Kubernetes Deployment through a Load Balancer: The service.yaml will be LoadBalancer.</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">dx29</span><span class="o">-</span><span class="n">apigateway</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">app</span><span class="o">-</span><span class="n">ingress</span>
<span class="n">spec</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">LoadBalancer</span>
    <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">port</span><span class="p">:</span> <span class="mi">80</span> 
    <span class="n">selector</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">dx29</span><span class="o">-</span><span class="n">apigateway</span><span class="o">-</span><span class="n">backend</span>
</pre></div>
</div>
<ul class="simple">
<li>Find the external IP of your Container: <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">svc</span></code>. And now you know the external IP address of your container: the microservice is now exposed on <code class="docutils literal notranslate"><span class="pre">http://&lt;public_IP&gt;:&lt;port&gt;</span></code>. Go to Azure Portal, access this Public IP resource and configure a DNS.</li>
</ul>
<p>The Dx29 application frontend is already associated to <a class="reference external" href="https://www.nginx.com/">nginx</a>, so it is already exposed through a public IP address and DNS configured in the Cluster. We did this when we first created the environment as seen in section 2.4 of this document, following these <a class="reference external" href="https://kubernetes.github.io/ingress-nginx/deploy/#azure">steps for Azure deployment</a>.</p>
<img width="800px" src="../../_images/acr_aks.png"></div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="3_Automation.html" class="btn btn-neutral float-right" title="3.3. Automation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="1_Build.html" class="btn btn-neutral float-left" title="3.1. Build" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Foundation29

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>